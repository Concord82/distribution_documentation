# Добавление нового воркспейса Optimacros:

В случае необходимости добавление нового воркспейса Optimacros, стоит учесть, что добавить можно только воркспейс, 
находящийся на отдельном сервере, т.е. не на том где стоит Логин Центр. Если имеется уже установленный воркспейс, на 
сервере с Логин центром для начала следует остановить работу имеющегося воркспейса. Это можно сделать при помощи команды
 (более подробная информация по остановке воркспейса смотрите [здесь](refresh.md)):

```/opt/om/workspace-installer/current/install workspace --path /opt/om/workspace1/manifest.json shutdown```

![](./pictures/sshPutty3.jpg)

Следующим этапом, нам понадобится сделать добавление новой сявзи в базе mongodb, логин центра.
К сожалению на данный момент, визуальных инструментов для этого не имеется и всё предстоит сделать вручную. 
 
 ## !!!Предупреждение: Неосторожное обращение с базами данных, может привести к необратимым последствиям!!!
 
 Далее воспользуемся командами:
 
`docker exec -it optimacros_db /bin/bash`

Затем введём команду:

`mongo --port 27017 -u DB_USERNAME -p  --authenticationDatabase 'admin'`

Где DB_USERNAME это имя пользователя базы данных, затем нужно будет ввести пароль к базе данных. После чего вводим 
команду:

`use logincenter`

Вся информация о подключаемых воркспейсах хранится в коллекции workspace, одной связи соответствует один документ.

Для просмотра всех документов коллекции workspace, используйте команду:

```
db.workspace.find({})
```

Формат документа:

```
{
    "_id": сгенерировано базой данных автоматически
    "id": "8522aedecc6b4219ee87ee28", случайное 16-ричное число длиной не менее 24 знаков, используется для проверки подключения воркспейса. !Не путать с полем _id!
    "name": "TEST", используется для навигации в UI Логин Центра и воркспейсов
    "description": "Тестовый воркспейс", описание показывается в UI Логин Центра
    "authenticationRedirectUrl": "https://om.test.workspace.ru/auth?token={userToken}", url воркспейса, путь /auth?token={userToken} всегда постоянный, домен (имя или IP адрес) должен соотв. добавляемому воркспейсу
    "domains": ["om.test.workspace.ru"], домен воркспейса без протокола http:// или https://
    "token": "4aed337a0ac34dd13716c476a4c7" СЕКРЕТНОЕ!!! случайное 16-ричное число длиной не менее 24 знаков, используется для проверки подключения воркспейса. 
}
```

При необходимости добавить новую связь создается новый документ и заполняется по схеме выше.

Пример команды обновления документа:

```
db.workspace.insertOne(...)
```

После всех манипуляций, с базой вводим:

`exit`


После добавления или изменения связи с воркспейсом необходимо перезапустить Логин Центр. Для этого введём 
последовательно команды:

```
./om stop app
./om start app
```

Далее нам необходимо внести изменения в файл манифеста самого воркспейса. Перейдём в директорию воркспейса, для этого 
вводим команду:

`cd /opt/om/worspace1/`

Находясь в этой директории, мы можем открыть для редактирования файл манифеста с помощью команды:

`nano manifest.json`

Этот файл выглядит примерно вот так:

```
{
  "container": {
    "ip": "10.0.3.15",
    "cpu": 6,
    "memory": 33685016576,
    "ports": {},
    "hosts": {},
  },
  "workspace": {
    "id": "8522aedecc6b4219ee87ee28",
    "name": "TEST",
    "web": {
      "url": "https://om.test.workspace.ru"
    },
    "loginCenter": {
      "url": "https://lc.company.ru/", // <= Интересующее нас поле
      "token": "4aed337a0ac34dd13716c476a4c7", // <= Интересующее нас поле
      "apiUrl": "wss://lc.company.ru/api/ws/v1/" // <= Интересующее нас поле
    },
    "admin": {
      "email": "admin@optimacros.com"
    }
  }
}
```

Нам нужно отредактировать поля Логин Центра, в частности url и apiUrl после редактирования, файл манифеста будет иметь 
примерно такой вид:

```
{
  "container": {
    "ip": "10.0.3.15",
    "cpu": 6,
    "memory": 33685016576,
    "ports": {},
    "hosts": {},
  },
  "workspace": {
    "id": "8522aedecc6b4219ee87ee28",
    "name": "TEST",
    "web": {
      "url": "https://om.test.workspace.ru"
    },
    "loginCenter": {
      "url": "https://адресЛогинЦентра/",
      "token": "токенЛогинЦентра",
      "apiUrl": "wss://адресЛогинЦентра/api/ws/v1/"
    },
    "admin": {
      "email": "admin@optimacros.com"
    }
  }
}
```

Затем запускаем работу воркспейса командой:

```/opt/om/workspace-installer/current/install workspace --path /opt/om/workspace1/manifest.json up```

![](./pictures/sshPutty7.jpg)

Дожидаемся такого вывода терминала:

![](./pictures/sshPutty8.jpg)

### Дополнительная информация:
При добавлении нового воркспейса в админке Логин Центра на странице воркспейса `http://.../admin/workspace/<ID>` 
подтвердить связь кнопкой `Grant Approval`, после чего пользователям можно будет давать к нему доступ. 

ID и токен воркспейса должны быть скопированы в конфигурационный файлы самого воркспейса.

В случае компроментации токена воркспейса его можно отключить кнопкой `Revoke Approval` на странице воркспейса в Логин 
Центре.

Для генерации 16-ричных чисел для значений полей id и token можно использовать онлайн сервисы, например: 
https://onlinehextools.com/generate-random-hex-numbers
  
[Вернуться к содержанию <](contents.md)

[Вернуться к оглавлению <<](index.md)
