# Экспертиза по проблеме с соединением воркспейса и логин центра.

При переходе в браузере по адресу воркспейса происходит переадресация на страницу логин центра и в некоторых случаях обратно, что приводит к бесконечному редиректу в влкадке браузера.

Проблема будет присутствовать у `ВСЕХ` пользователей, если проблема есть только у некоторого числа пользователей, то данных способ не относится к решению проблемы.

Интрукция предполагает, что воркспейс установлен в папку `/opt/om/workspace1`, используйте папку в которую у вас установлен воркспейс, т.е. находится файл с манифестом

## Проблема с DNS вне контейнера

Обычно самая частая проблема в определении IPv4 адреса логин центра по его хост имени.

Проверим соединение с хостом с помощью команд:

```
ping ХостЛогинЦентра
telnet ХостЛогинЦентра 443
```

Проверим соединение с IPv4 Логин Центра с помощью команд:
```
ping IPv4ЛогинЦентра
telnet IPv4ЛогинЦентра 443
```

В случае с установленным логин центром и воркспейсом на разных машинах, `IPv4ЛогинЦентра` будет внешним адресом машины на котором установлен логин центр.
В случае с установленным логин центром и воркспейсом на одной машине, `IPv4ЛогинЦентра` будет внешним адресом машины на котором установлен логин центр и воркспейс или адресом `Nginx Docker контейнера` логин центра, по умолчанию `10.5.0.2`

При отсутствии проблем, переходим к следующему способу диагностики

## Диагностика в LXC контейнере воркспейса

Воркспейс находится в LXC контейнере, который управляется утилитой `vagrant`, для диагностирования нужно зайти в вагрант машину и проверить, что Логин Центр доступен. 

Перейдём в директорию вагрант с помощью команды: 

```
cd /opt/om/workspace1/container
```

Далее находясь в директории введём команду:

```
vagrant ssh
```

Теперь вы находитесь в командной строке LXC контейнера с правами пользователя `vagrant`, для работы под `root` пользователем вы можете воспользаться возможность повышения привилегий с помощью команды `sudo su`

### Проблема с DNS внутри контейнера

Проверим соединение с хостом Логин Центра с помощью команд:

```
telnet ХостЛогинЦентра 443
ping ХостЛогинЦентра
```

Если доступа нет, то возможно проблема в определении ресурса через доменное имя. В этом случае проверим соединение с IPv4 адресом Логин Центра:

```
telnet IPv4ЛогинЦентра 443
ping IPv4ЛогинЦентра
```

Если доступ есть, то добавьте в секцию `container.hosts` манифеста воркспейса пару для `ХостЛогинЦентра` и его `IPv4ЛогинЦентра`

```
{
  "container": {
    ...
    "hosts": {
      "ХостЛогинЦентра": "IPv4ЛогинЦентра"
    }
    ...
  },
  ...
}
```

### Другие варианты

Если проблема не в DNS, техническим специалистам Optimacros нужно передать информацию из журнала логов сервиса `ws-server`

`ws-server` - воркспейс сервис, который отвечает за коммуникацию с Логин центром

Внутри контейнера выполняем команду
```
sudo journalctl -u ws-server --since "30 min ago" --no-pager > /vagrant/ws-server.logs
```

Папки `/vagrant` в контейнере и `/opt/om/workspace1/container` на хосте синхронизированы, поэтому файл будет доступен на хосте по адресу `/opt/om/workspace1/container/ws-server.logs`

Далее файл или архив с файлом необходимо передать техническим специалистам Optimacros, для определения проблемы

[Вернуться к экспертизе <](expertise.md)

[Вернуться к оглавлению <<](index.md)


